<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Detalhes do Paciente</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .consultation { margin-bottom: 10px; padding: 10px; border-left: 5px solid #007bff; cursor: pointer; }
        .consultation:hover { background-color: #e9ecef; }
        .details { display: none; margin-top: 10px; padding: 10px; background: #f9f9f9; }
    </style>
</head>
<body>
    <button onclick="window.history.back()">Voltar</button>
    <h1>Detalhes do Paciente</h1>
    <div id="patient-info"></div>
    <h2>Medicações Atuais</h2>
    <ul id="medications"></ul>
    <h2>Histórico de Consultas</h2>
    <div id="consultations"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const cpf = urlParams.get('cpf');

        async function loadPatient() {
            const response = await fetch(`/patient/${cpf}`);
            const patient = await response.json();
            displayPatient(patient);
        }

        function displayPatient(patient) {
            document.getElementById('patient-info').innerHTML = `
                <p><strong>Nome:</strong> ${patient.patient.nome}</p>
                <p><strong>CPF:</strong> ${patient.patient.cpf}</p>
                <p><strong>Idade:</strong> ${patient.age}</p>
            `;
            const medList = document.getElementById('medications');
            medList.innerHTML = '';
            patient.current_medications.forEach(m => {
                const li = document.createElement('li');
                li.textContent = `${m.name} - ${m.dosage} (desde ${m.start_date})`;
                medList.appendChild(li);
            });
            const consDiv = document.getElementById('consultations');
            patient.consultations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            patient.consultations.forEach(c => {
                const div = document.createElement('div');
                div.className = 'consultation';
                div.innerHTML = `
                    <strong>${c.timestamp}</strong><br>
                    Médico: ${c.doctor.nome} (${c.doctor.especialidade})<br>
                    Arquivo: ${c.filename}
                    <div class="details">
                        <strong>Hipótese Diagnóstica:</strong><br>${c.hipotese_diagnostica}<br><br>
                        <strong>Conduta:</strong><br>${c.conduta}
                    </div>
                `;
                div.onclick = () => {
                    const details = div.querySelector('.details');
                    details.style.display = details.style.display === 'none' ? 'block' : 'none';
                };
                consDiv.appendChild(div);
            });
        }

        window.onload = loadPatient;
    </script>
</body>
</html>