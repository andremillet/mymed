<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Visualizador de Arquivos Médicos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #search { margin-bottom: 20px; }
        #patients { list-style: none; padding: 0; }
        .patient { cursor: pointer; padding: 10px; border: 1px solid #ccc; margin-bottom: 5px; }
        .patient:hover { background-color: #f0f0f0; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .consultation { margin-bottom: 10px; padding: 10px; border-left: 5px solid #007bff; cursor: pointer; }
        .consultation:hover { background-color: #e9ecef; }
    </style>
</head>
<body>
    <h1>Visualizador de Arquivos Médicos</h1>
    <div id="search">
        <input type="text" id="query" placeholder="Buscar por nome ou CPF" autocomplete="off">
        <button onclick="search()">Buscar</button>
    </div>
    <div id="actions">
        <button onclick="showNewPatient()">Novo Paciente</button>
        <button onclick="showImportPatient()">Importar Paciente</button>
        <button onclick="listPatients()">Listar Pacientes</button>
    </div>
    <div id="pagination">
        <button id="prev" onclick="loadPatients(currentPage - 1)">Anterior</button>
        <span>Página <span id="pageNum">1</span></span>
        <button id="next" onclick="loadPatients(currentPage + 1)">Próxima</button>
    </div>
    <ul id="patients"></ul>
    <div id="newPatientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newPatientModal')">&times;</span>
            <h2>Novo Paciente</h2>
            <form onsubmit="submitNewPatient(event)">
                <label>CPF: <input type="text" id="newCpf" required></label><br>
                <label>Nome: <input type="text" id="newNome" required></label><br>
                <label>Data Nascimento (DD/MM/AAAA): <input type="text" id="newBirth" required></label><br>
                <button type="submit">Cadastrar</button>
            </form>
        </div>
    </div>
    <div id="importPatientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('importPatientModal')">&times;</span>
            <h2>Importar Paciente</h2>
            <form onsubmit="submitImportPatient(event)">
                <label>Caminho do arquivo .med: <input type="text" id="importPath" required></label><br>
                <button type="submit">Importar</button>
            </form>
        </div>
    </div>
    <div id="listPatientsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('listPatientsModal')">&times;</span>
            <h2>Pacientes Cadastrados</h2>
            <ul id="patientList"></ul>
        </div>
    </div>
    <div id="modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Histórico de Consultas</h2>
            <div id="consultations"></div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        const limit = 10;

        async function loadPatients(page = 1) {
            currentPage = page;
            const response = await fetch(`/patients?page=${page}&limit=${limit}`);
            const pats = await response.json();
            displayPatients(pats);
            updatePagination(pats.length < limit);
        }

        function displayPatients(pats) {
            const list = document.getElementById('patients');
            list.innerHTML = '';
            pats.forEach(p => {
                const li = document.createElement('li');
                li.className = 'patient';
                li.innerHTML = `
                    ${p.patient.nome} - CPF: ${p.patient.cpf}
                    <div class="options" style="display:none; margin-top:5px;">
                        <button onclick="event.stopPropagation(); viewPatient('${p.patient.cpf}')">Visualizar Paciente</button>
                        <button onclick="event.stopPropagation(); showTimeline(p)">Histórico de Consultas</button>
                    </div>
                `;
                li.onclick = () => {
                    const options = li.querySelector('.options');
                    options.style.display = options.style.display === 'none' ? 'block' : 'none';
                };
                list.appendChild(li);
            });
        }

        function viewPatient(cpf) {
            window.location.href = `patient.html?cpf=${cpf}`;
        }

        function updatePagination(isLast) {
            const prevBtn = document.getElementById('prev');
            const nextBtn = document.getElementById('next');
            const pageNum = document.getElementById('pageNum');
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = isLast;
            pageNum.textContent = currentPage;
        }

        async function search() {
            const q = document.getElementById('query').value;
            currentPage = 1;
            const response = await fetch(`/search?q=${encodeURIComponent(q)}&page=${currentPage}&limit=${limit}`);
            const pats = await response.json();
            displayPatients(pats);
            updatePagination(pats.length < limit);
        }

        function showTimeline(patient) {
            const modal = document.getElementById('modal');
            const consDiv = document.getElementById('consultations');
            consDiv.innerHTML = `
                <h3>Detalhes do Paciente</h3>
                <p><strong>Nome:</strong> ${patient.patient.nome}</p>
                <p><strong>CPF:</strong> ${patient.patient.cpf}</p>
                <p><strong>Idade:</strong> ${patient.age}</p>
                <h3>Histórico de Consultas</h3>
            `;
            patient.consultations.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            patient.consultations.forEach(c => {
                const div = document.createElement('div');
                div.className = 'consultation';
                div.innerHTML = `
                    <strong>${c.timestamp}</strong><br>
                    Médico: ${c.doctor.nome} (${c.doctor.especialidade})<br>
                    Arquivo: ${c.filename}
                    <div class="details" style="display:none; margin-top:10px; padding:10px; background:#f9f9f9;">
                        <strong>Hipótese Diagnóstica:</strong><br>${c.hipotese_diagnostica}<br><br>
                        <strong>Conduta:</strong><br>${c.conduta}
                    </div>
                `;
                div.onclick = () => {
                    const details = div.querySelector('.details');
                    details.style.display = details.style.display === 'none' ? 'block' : 'none';
                };
                consDiv.appendChild(div);
            });
            modal.style.display = 'block';
        }

        function closeModal(id) {
            if (id) {
                document.getElementById(id).style.display = 'none';
            } else {
                document.getElementById('modal').style.display = 'none';
            }
        }

        function showNewPatient() { document.getElementById('newPatientModal').style.display = 'block'; }
        function showImportPatient() { document.getElementById('importPatientModal').style.display = 'block'; }
        function listPatients() { 
            document.getElementById('listPatientsModal').style.display = 'block';
            document.getElementById('patientList').innerHTML = '<li>Funcionalidade em desenvolvimento</li>';
        }

        async function submitNewPatient(event) {
            event.preventDefault();
            alert('Funcionalidade em desenvolvimento');
        }

        async function submitImportPatient(event) {
            event.preventDefault();
            alert('Funcionalidade em desenvolvimento');
        }

        window.onload = () => loadPatients(1);
    </script>
</body>
</html>